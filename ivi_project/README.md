# IVI-Project

# Создание рекапов сериалов

## Цель
Проект по автоматизированному созданию рекапов сериалов с использованием ИИ.

На основе данных и субтитров система определяет ключевые моменты в сериале. Затем выделяет соответствующие тайм-коды и вырезает эти сцены. Для формирования связного рекапа субтитры обрабатываются с помощью LLM, которая генерирует осмысленный текст. Видеофрагменты ключевых сцен объединяются в единый видеопоток, формируя итоговый рекап.

## Данные

## Функционал

### 1. Обработка субтитров
- Извлечение реплик с таймкодами (хранение в JSON)
- Очистка от мусора (пропуски в данных, написанные в скобках эмоции, например: (смех))
- Подготовить датасет
- Применить LLM для генерации связного рекапа

### 2. Обработка видео
- Обрезка видео по таймкодам (интервал [start, end])
- Объединение нескольких видео в один видеопоток
- Добавление заставки "В предыдущих сериях"

### 3. Docker
- Создать docker-образ со всеми необходимыми зависимостями, внутри которого можно вызвать скрипт и получить результат, а также инструкцию, как всё собирать и запускать

### 4. Интеграция
- Связь обработки субтитров и видео
- Найти/создать анимационного вступления
- Автоматическое создание итогового ролика

## Использованные технологии
- Язык программирования: Python
- Фреймворки и библиотеки:
  - numpy
  - pandas
  - scipy
  - scikit-learn
  - matplotlib
  - seaborn
  - moviepy
  - transformers

 ## Результаты

### Docker команды
- Аутентификация в Docker Hub:
   ```bash
   docker login
- Загрузка Docker-образа
  ```bash
  docker pull smozhogin/ivi_image:0.0.3
- Создание тома для хранения данных
  ```bash
  docker volume create storage
- Запуск контейнера
  ```bash
  docker run -it \
  -e LC_ALL=ru_RU.UTF-8 \
  --gpus all \
  --memory=4g \
  --cpus=2 \
  --name ivi \
  --hostname ivi \
  -v storage:/app/data \
  ivi_image:0.0.3
- Работа внутри контейнера
  ```bash
  # Активация виртуальной среды
  source /app/venv/ivi/bin/activate

  # Проверка версии Python
  python --version

  # Просмотр установленных пакетов
  pip list

  # Использование текстовых редакторов
  nano файл.txt
  # или
  vim файл.txt

  # Деактивация среды
  deactivate
- Управление версиями Python
  ```bash
  # Для Python 3.10
  ln -sf /usr/bin/python3.10 /usr/bin/python

  # Для Python 3.12
  ln -sf /usr/bin/python3.12 /usr/bin/python
- Создание новой виртуальной среды
  ```bash
  virtualenv -p python3.10 my_env

### Обработка видео
- Написана функция для обрезки видео по тайм-кодам
- Написана функция для для обьединения нескольких видео в один видеопоток
- Написана функция длядобавления интро "В предыдущих сериях"

### Обработка субтиров
- Написаны функции для предобработки файлов с субтитрами и сохранением их в json `preproc_files.py`
  1. Ищет все `.srt`-файлы в указанной папке (`subtitles/`) и конвертирует их в json-файлы с нужной структурой.
  2. Очищает текст субтитров от неинформативных вставок (например, `(смех)`).
  3. Результирующие json сохраняются в `subtitles/processed_json/`.
- Написана функция для очистки данных:
  1. Данные до обработки:
    ```srt
    
    1
    00:00:22,710 --> 00:00:26,475
    Итак, наша героиня
    Елена Ивановна Подберезкина
    ```
  2. Данные после обработки: 
  ```json
    {
  "series_id": 14194,
  "season": 1,
  "episode": 1,
  "filename": "14194_1_1.srt",
  "subtitles": [
    {
      "index": 1,
      "start": "00:00:31,173",
      "end": "00:00:34,293",
      "text": "Елена Ивановна Березкина шла по жизни маршем,",
      "clean_text": "Елена Ивановна Березкина шла по жизни маршем,"
    },

- Функция для герации субтитров из рекапов `recaper.py`

  1. Принимает на вход json-файл (output предыдущего шага).
  2. Делит субтитры на смысловые блоки (по 30 секунд).
  3. Для каждого блока генерирует краткое summary (с помощью LLM).
  4. Финальный recap строится по всем summary-блокам — ровно 5 ключевых моментов с тайм-кодами.
  4. Recap можно использовать для нарезки видеорекапа и интеграции с видео.
  5. Использована модель YandexGPT5 для генерации рекапов
     - Качество генерации: YandexGPT5 — одна из самых современных языковых моделей, способная генерировать связные, осмысленные и контекстно-релевантные тексты.
     - Доступность и интеграция: Yandex предоставляет удобные API и инструменты для работы с моделью.
     - Поддержка русского языка

## Объединение:
- Объединено все в общий функционал
- Написана функция для преобразования ответа модели в формат для нарезки видео и текстового рекапа

  **Пример ответа модели:**
  ```bash
  14194_1_1.json [00:01:01,173–00:01:31,173] – лучшая подруга подвергает сомнению привлекательность Елены Ивановны для мужчин, дав ей сутки на то, чтобы это доказать встречей с мужчиной;
  14194_1_1.json [00:03:01,173–00:03:31,173] – Елена Ивановна заполняет анкету для сайта знакомств, слегка искажая свой возраст;
  14194_1_1.json [00:06:01,360–00:06:28,924] – Елена Ивановна решает воспользоваться Тиндером для поиска партнёра, знакомится со шведским мужчиной, который приглашает её в Русский музей;
  14194_1_1.json [00:09:16,115–00:10:16,088] – Елена Ивановна пытается доказать подруге свою привлекательность, используя необычные методы, включая просьбу сделать селфи в кровати;
  14194_1_1.json [00:14:56,265–00:15:16,060] – главный герой принимает решение довериться судьбе и перестать принимать самостоятельные решения относительно своей жизни.


**Запуск:**
```bash
pip install -r requirements.txt
python main.py --srt path_subtitles  --mp4 path_video
```
path_subtitles - путь к файлам с субтитрами

path_video - путь к файлу с видео

После выполнения работы создается два файла video_recap.mp4 и text_recap.txt, первый хранит видеорекап, в второй текстовый рекап. 

##Примеры созданных видео и текстовых рекапов:
- Видеорекап: [Видео](video_recap.mp4)
- Текстовый рекап: [Текст](text_recap.txt)

**Запуск из Docker:**
См. выше инструкцию по загрузке образа Docker и созданию контейнера

```bash
/app/venv/ivi/bin/python /app/project/ivi/main.py --srt path_subtitles --mp4 path_video
```
path_subtitles - путь к файлам с субтитрами

path_video - путь к файлу с видео
