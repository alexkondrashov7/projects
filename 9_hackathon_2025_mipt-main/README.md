# Сервис по кластеризации и классификации клиентов на RFM_ABC_XYZ анализа с когортной компонентной.

Данный проект направлен на снижение вероятности оттока клиентов за счёт выявления ключевых групп в клиентской базе и последующего таргетированного маркетингового воздействия. Однако стоит отметить, что результаты классификации не оправдали ожиданий из-за неподтвердившихся гипотез и некорректной разметки на основе кластеризации. Поэтому в дальнейшем весь анализ будет проводиться в контуре RFM+ABC+XYZ анализа клиентов.

## Как это работает:

1. **Кластеризация клиентов**: Алгоритм производит кластеризацию клиентов на ключевые группы для синтетической разметки датасета на основе их поведения и/или латентных признаков (в дальнейшем было выявлена несостоятельность подхода).

2. **Приоритизация групп**: Выделяются сегменты с высоким риском оттока (одноразовые клиенты), потенциально лояльные и лояльные с максимальной ценностью для бизнеса.

3. **Проведение когортного анализа**: На основе сгруппированного датасета был произведен когортный анализ покупателей, для формирования возможной базы рекомендательной системы.

4. **Классификация клиентов**: На основе сформированных меток групп создается датасет для фильтрации на дашборде, выделяющий группы клиентов в разрезе региона активности. Используется визуализация geo-heatmap.

5. **Визуализация на основе ABC_RFM анализа в контектсе временной динамики** Используя метки с этапа rfm_abc_xyz-анализа визуализируется распределение по группам клиентов в разрезе временных интервалов.

---
---
## Содержание

- [Данные](#данные)
- [EDA](#eda)
- [Примеры](#примеры)
- [Как работает](#как-работает)
- [Архитектура](#архитектура)
- [Техническая реализация](#техническая-реализация)
- [Процесс разработки](#процесс-разработки)
- [Результат](#результат)
- [Дальнейшее развитие](#далее-развитие)
- [Контрибьюторы](#контрибьюторы)

---
---
### Данные

При создании сервиса использовался комбинированный датасет, состоящий из разрозненных выгрузок БД. Произведено слияние первичных таблиц на основе логики сопоставления внешних ключей и очистка от дублей и признаков с высоким уровнем пропусков (> 60%). Для удобства был сформирован унифицированный скрипт экстрактор, для обхода ограничений на размер загружаемых на GitHub данных (с потенциалом замены на модельную БД).

Первичный датасет состоит из нормализованных табличных данных, описывающих транзакционную, поведенческую, геолокационную и временную сущности клиентов онлайн-магазина.

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/schema_data.png">

Для работы была произведена денормализация и feature-инжиниринг для создания комбинированного и/или латентного признакового пространства для параллельной кластеризации методами RFM-анализа и KMeans-кластеризации.

Нужно отметить, что в процессе изучения данных на основе кластерного анализа был выявлен существенный дисбаланс кластеров-классов.

:arrow_up: [К содержанию](#содержание)

---
---
### EDA

([Jupyter Notebook](https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/eda.ipynb))

#### Можно наблюдать длинный правый хвост распределения, что естественно приводит распределение к форме близкой к нормальной в случае логарифмирования признака, т.н. логнормальное распределение цены.

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/eda/price_distr.png">

---
#### Основная часть покупок производится путем оплаты с кредитной карты, на втором месте стоит оплата инвойсами - B2B сегмент

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/eda/payment_type_distr.png">

---
#### Можно наблюдать пересечение по модальному региона как у продавцов так и у покупателей, но при этом можно предположить наличие логистических проблем-задержек доставки для регионов покупателей PR, MG, RJ.

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/eda/region_distr.png">

---
#### Мультимодальное распределение явно прослеживаются ключевые группы товаров, пользующиеся спросом:
- Товары для ремонта
- Фурнитура и декор
- Красота и здоровье
- Домашняя утварь
- Акксессуары для ПК
- Подарки
- Спорт товары
- Игрушки 

#### Что говоорит о том, что мы имеем дело со стандартным маркетплейсом.

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/eda/product_category_distr.png">

---
#### Можно отметить положительную динамику прироста продаж

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/eda/purchase_dynamic.png">

---
#### По больлшей части покупатели остаются довольными приобретенными товарами

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/eda/review_score_distr.png">


:arrow_up: [К содержанию](#содержание)

---
---
### Примеры

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/examples/photo_2025-04-20_17-21-59.jpg">

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/examples/photo_2025-04-20_17-22-06.jpg">

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/examples/photo_2025-04-20_17-22-09.jpg">

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/examples/photo_2025-04-20_17-22-16.jpg">

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/examples/photo_2025-04-20_17-22-16.jpg">

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/services/results/plots/churn_risk_by_time_via_Churn_Risk.png">

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/services/results/plots/churn_risk_by_time_via_segment_description.png">

---
---
### Как работает

Система состоит из нескольких модулей, включающих в себя сервис RFM-анализа и отдельный сервис когортного анализа.

:arrow_up: [К содержанию](#содержание)

---
---
### Архитектура
Архитектура приложения (финальная)

Архитектура приложения строиться по компонентному подходу и включает следующие ключевые модули:

1. Сбор данных: Модуль, отвечающий за экспорт данных из различных источников данных (БД, API, CSV-файлы). Он включаеть в себя ETL (Extract, Transform, Load) процессы для подготовки данных к последующему анализу.

2. Обработка данных: Производится денормализация, очистка и трансформация данных. Используются библиотеки, такие как Pandas и NumPy для анализа и манипуляции данными. Реализован процесс обработки в режиме реального времени для динамических данных.

3. Модуль кластеризации: Отдельный сервис для выполнения RFM, ABC и XYZ анализа. 

4. Визуализация данных: Модуль для представления данных на дашборде с возможностями интерактивной визуализации. 

#### Планы на будущее:

5. Рекомендательная система: Будет разрабатываться на основе когортного анализа, предоставляя персонализированные советы клиентам по улучшению их опыта.

6. Мониторинг и поддержка: Модуль для мониторинга производительности системы и качества данных, с функциями логирования и аварийного реагирования. Будет отслеживаться использование ресурсов и производительность приложения в реальном времени.

7. API для интеграции: Разработка RESTful API для интеграции с другими приложениями и системами, что позволит взаимодействовать с сервиса внутри и вне корпоративного окружения.

---
---

### Техническая реализация

#### Язык программирования:
- **Python**: Основной язык разработки, обеспечивающий гибкость и разнообразие библиотек для анализа данных и машинного обучения.

#### Аналитика:
- **Pandas**: Библиотека для высокопроизводительной обработки и анализа данных на Python, позволяет удобно работать с таблицами и временными рядами.
- **NumPy**: Библиотека для работы с многомерными массивами и матрицами, обеспечивающая поддержку больших матричных операций.

#### Визуализация:
- **Plotly**: Интерактивная библиотека для визуализации данных, поддерживающая разнообразные графики и визуализации.
- **Folium**: Используется для создания интерактивных карт на основе данных тревелинга и геолокации.
- **Seaborn**: Библиотека для визуализации статистических данных, упрощающая создание сложных графиков.

#### Машинное обучение:
- **Scikit-learn**: Библиотека для выполнения машинного обучения на Python, включающая алгоритмы кластеризации (например, KMeans) и базовые методы классификации.
- **TensorFlow**: Платформа для разработки моделей глубокого обучения, используется для тестирования и обучения нейронных сетей.
- **XGBoost**: Эффективная и масштабируемая библиотека для градиентного бустинга, используемая для построения высококачественных моделей предсказания и классификации.

#### Инфраструктура:
- **FastAPI**: Высокопроизводительный веб-фреймворк для создания API на Python, обеспечивающий асинхронную обработку запросов.
- **Flask**: Легковесный веб-фреймворк для создания веб-приложений и API на Python, позволяющий быстро разрабатывать и развертывать приложения.
- **React**: Библиотека JavaScript для создания пользовательских интерфейсов, позволяющая строить интерактивные и отзывчивые веб-приложения, которые эффективно взаимодействуют с бэкенд-сервисами.
- **GitHub**: Платформа для хранения и совместной разработки кода, позволяющая выполнять контроль версий и управление проектами.
- **GitHub Actions**: Система автоматизации рабочего процесса на GitHub, позволяющая настраивать CI/CD (непрерывная интеграция и непрерывная доставка) для автоматического тестирования и развертывания приложения.

#### Потенциальное масштабирование:
- **PostgreSQL**: Мощная реляционная база данных, обеспечивающая надежное хранение и обработку данных.
- **Apache Superset**: Инструмент для визуализации данных и мониторинга бизнес-показателей, способный интегрировать аналитические отчеты.
- **Apache Airflow**: Платформа для управления рабочими процессами и автоматизации ETL-процессов, позволяющая планировать и контролировать выполнение задач.


---
---
### Процесс разработки

1. Были проведены исследования по МЛ кластеризации объектов ([Jupyter Notebook](https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/clusterisation.ipynb)) и RFM-сегментации ([Jupyter Notebook](https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/rfm.ipynb)).

   В обоих случаях были выявлены определенные пересечения в кластеризации:

   #### RFM-кластеризация
   <img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/labels/rfm_chart.png">

   Выбор количества кластеров обусловлен методологией.

   #### KMeans
   <img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/labels/kmeans_chart.png">

   Выбор количества кластеров был основан на паритете между силуэтом и инерцией.
   
   <img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/labels/kmeans_chart_силуэт.png">

2. На основе RFM и KMeans кластеризации было произведено сегментирование клиентской базы исходя из ключевых эвристик, с уклоном в базис RFM разметки, где были сформированы 3 ключевые группы:
   - Лояльные клиенты
   - Потенциально лояльные клиенты
   - Разовые клиенты

   <img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/labels/combo_chart.png">

   В процессе тестового обучения классификатора было выявлено отсутствие связи признаков и комбинированной разметки. Использование глубокой сети показало расходящийся лосс.
   
   При этом обучение классификатора с метками из RFM-анализа (как более обоснованного методологически) на фитах, которые использовались при KMeans кластеризации (фитах, которые не использовались при RFM, а значит утечки быть не может), показало достаточно обнадеживающие результаты.

3. Формируем портрет клиента на основе подхода, который мы использовали для KMeans, но с учетом тех фитров, которые мы можем поймать даже при первой покупке клиента, т.е. группа товаров, город, цена товара, оценка товара, что-то, что позволит нам идентифицировать клиента гораздо заранее с определенной долей вероятности. Затем приклеиваем метки из RFM и обучаем классификатор на основе нейронной сети.

4. В рамках предварительного этапа исследования был проведён первичный анализ пользовательского поведения на основе датасета ([Jupyter Notebook](https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/rostelecom_ipynb.ipynb)). 
   
   Цель анализа заключалась в формировании и проверке продуктовых гипотез, способных выявить скрытые закономерности, влияющие на покупки, оценки и потенциальный отток пользователей. Гипотезы формировались на основании здравых предположений о логике поведения пользователей и затем проверялись статистически. 

   Наиболее выраженное влияние на ключевые пользовательские метрики (частота заказов, повторные покупки, оценки) оказали время доставки, географические характеристики (как покупателей, так и продавцов), тип оплаты, а также временные факторы (день недели, время суток).

5. Классификаторы показатели плохую обобщающу способность на разных архитектурах ([Jupyter Notebook](https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/classificator.ipynb)) и было решено уйти в аналитическую ветку.

6. Было произведено исследование в рамках RFM_XYZ_ABC анализа ([Jupyter Notebook](https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/rfm_abc_xyz.ipynb))

7. На основе пердыдущего пункта было сформированно исследование в разрезе временного распределения ([Jupyter Notebook](https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/research/churn_rfm_time.ipynb))

---
# В результате анализа были выдвинуты следующие гипотезы:

## Гипотезы и результаты анализа

1. **Гипотеза #1:** Пользователи, живущие в крупных городах, таких как Sao Paulo или Rio de Janeiro, не только делают больше покупок, но и имеют более высокую частоту покупок на одного пользователя по сравнению с теми, кто живет в менее крупных или удалённых регионах.
   - **Результат:**
     - *city_group*
       - Large City: 1.213623
       - Other City: 1.193724
   - **Подтверждена:** Нет, разница маленькая.

2. **Гипотеза #2:** Количество фотографий влияет на количество заказов.
   - **Результат:** Корреляция между количеством фотографий и количеством заказов: 0.009723859445886449.
   - **Подтверждена:** Нет.

3. **Гипотеза #3:** Пользователи, которые оставляют отзывы, более лояльны и чаще совершают покупки.
   - **Результат:** 
     - Среднее количество заказов у пользователей, оставивших отзывы: 1.1981792198168635.
     - Среднее количество заказов у пользователей, не оставивших отзывы: 1.1666666666666667.
   - **Подтверждена:** Есть небольшая корреляция.

4. **Гипотеза #4:** Покупатели, использующие определённые способы оплаты, более склонны делать крупные заказы (средняя сумма заказов).
   - **Результат:**
     - | payment_type  | payment_value |
       |---------------|---------------|
       | boleto        | 175.77        |
       | credit_card   | 178.61        |
       | debit_card    | 149.45        |
       | voucher       | 64.28         |
   - **Подтверждена:** Да.

5. **Гипотеза #5:** Товары с более длинными описаниями имеют больше заказов.
   - **Результат:** (не был указан)
   - **Подтверждена:** Нет.

6. **Гипотеза #6:** Частота покупок в определённые сезоны (например, распродажи или праздники) возрастает.
   - **Результат:** Сложно судить, так как данные по 2016 году были неполными, 2017 показал активный рост к концу года, а 2018 - только на начало года.
   - **Подтверждена:** Не указано.

7. **Гипотеза #7:** Удовлетворённость клиентов (из отзывов) зависит от того, насколько быстро товар был доставлен.
   - **Результат:** Самая сильная (отрицательная) корреляция:
     - delivery_time: -0.303545, чем дольше доставка, тем ниже оценки.
     - payment_value: -0.081312, возможно, более дорогие заказы вызывают завышенные ожидания и, если что-то не так, клиенты ставят низкие оценки.
   - **Подтверждена:** Да.

8. **Гипотеза #8:** Покупатели, которые делают покупки в определённые дни недели, чаще делают покупки в будущем.
   - **Результат:** Нет корреляции.
   - **Подтверждена:** Нет.

9. **Гипотеза #9:** Больше всего заказов в определенное время.
   - **Результат:** С 10 до 16 наибольшее количество заказов, можно отправлять пуши или напоминания в это время.
   - **Подтверждена:** Да.

10. **Гипотеза #10:** Больше всего заказов в определенные дни недели.
    - **Результат:** Больше всего продаж по понедельникам и вторникам, меньше всего в субботу.
    - **Подтверждена:** Да.

11. **Гипотеза #11:** Покупатели, получившие товары быстрее, могут быть более склонны делать повторные покупки.
    - **Результат:**
      - | is_repeat_customer  | Среднее количество заказов |
        |---------------------|----------------------------|
        | False               | 12.114187                  |
        | True                | 11.612573                  |
    - **Подтверждена:** Да, покупатели, которые не делают повторные заказы (False), получают товары немного быстрее, чем новые клиенты.

12. **Гипотеза #12:** Пользователи, которые покупают более дешевые товары, делают больше повторных покупок по сравнению с теми, кто покупает товары более высокой стоимости.
    - **Результат:**
      - | price_category | is_repeat_customer |
        |---------------|--------------------|
        | Cheap         | 0.325473           |
        | Expensive     | 0.223915           |
    - **Подтверждена:** Да.

13. **Гипотеза #13:** Покупатели, которые делают больше покупок, с большей вероятностью оставляют отзывы о товарах.
    - **Результат:** Корреляция между количеством покупок и наличием отзыва: -0.01460151300588903.
    - **Подтверждена:** Нет.

14. **Гипотеза #14:** Продавцы из разных регионов могут иметь разные оценки из-за особенностей логистики или культуры обслуживания.
    - **Результат:** Подтверждено, есть зависимости по убыванию количества заказов.
    - **Подтверждена:** Да.

15. **Гипотеза #15:** Как рейтинг продавца соотносится с количеством товаров в заказах.
    - **Результат:** Корреляция между количеством товаров в заказе и средней оценкой: -0.09456166325015361.
    - **Подтверждена:** Нет.

16. **Гипотеза #16:** Средние оценки варьируются в зависимости от месяца и сезона.
    - **Результат:** Наилучшие оценки в августе, летом.
    - **Подтверждена:** Да.

17. **Гипотеза #17:** В мегаполисах покупают дороже - больше доход, дороже логистика, другие привычки.
    - **Результат:** Подтверждено.
    - **Подтверждена:** Да.

18. **Гипотеза #18:** Чем дольше доставка, тем ниже оценка.
    - **Результат:** Среднее время доставки по оценкам:
      - | review_score | Среднее время доставки |
        |--------------|------------------------|
        | 1.0          | 19.14                  |
        | 2.0          | 15.30                  |
        | 3.0          | 13.57                  |
        | 4.0          | 11.78                  |
        | 5.0          | 10.20                  |
    - **Подтверждена:** Да.

---

По результатам первичного анализа рекомендуется сосредоточить внимание на следующих направлениях:
- Фокус на доставке и географии, так как они заметно влияют на оценки и повторные заказы.
- Использование данных о времени активности пользователей при построении маркетинговых коммуникаций и push-стратегий.
- Скептически относиться к описаниям и фотографиям - они важны, но на конверсии почти не влияют.

5. На основе исследований были созданы микросервисы для разметки первичных данных KMeans-метками ([KMeans Service](https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/services/kmeans.py)) и RFM-метками ([RFM Service](https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/services/rfm.py)).

6. Были созданы микросервисы для RFM и Когортного анализа

7. Для бэкенд-решения было создано базовое приложение ([Inference Service](https://github.com/OIJTUMUCT/inference_service/tree/main)), которое отвечает за инференс модели.

:arrow_up: [К содержанию](#содержание)

---
---
### Результат

Результатом проведенной работы служит сервис визуализации в разрезе произведенной RFM и когортной кластеризации пользователей на карте региона.

Первичные гипотезы по синтетической разметке не подтвердились посему был произведен поворот в сторону аналитики.

### RFM-анализ
<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/services/results/plots/churn_risk_by_time_via_Churn_Risk.png">

> Высокий риск = новый клиент, вероятно одноразовая покупку

> Средний риск = стабилизационный сегмент, возможно клиент потенциально долгосрочный

> Низкий риск = лояльный клиент с долгой историей покупок

> Можно отметить снижение активности лояльных клиентов и переход в фазу накопления новой клиентской базы, возможно требуется воздействие на лояльный кластер.

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/services/results/plots/churn_risk_by_time_via_segment_description.png">

> 'A_Single Purchase': 'Клиенты с одной покупкой, высокий денежный объем.'

> 'B_Single Purchase': 'Клиенты с одной покупкой, средний денежный объем.'

> 'C_Single Purchase': 'Клиенты с одной покупкой, низкий денежный объем.'

> 'A_X': 'Высокоприбыльные клиенты, низкая вариативность.'

>'B_X': 'Клиенты со средней частотой и объемом, низкая вариативность.'

> 'C_X': 'Клиенты с низким объемом, низкая вариативность.'

> 'A_Y': 'Высокоприбыльные клиенты с разумной вариативностью.'

> 'B_Y': 'Средние клиенты с некоторой вариативностью.'

> 'C_Y': 'Клиенты с низким объемом и частотой, но с вариативностью.'

> 'A_Z': 'Высокоприбыльные клиенты с большой вариативностью.'

> 'B_Z': 'Средние клиенты с высокой вариативностью.'

> 'C_Z': 'Низкие клиенты с высокой вариативностью.'

### Когортный анализ

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/examples/photo_2025-04-20_18-46-08.jpg">

<img src="https://github.com/alexkondrashov7/-hackathon_2025_mipt/blob/main/examples/photo_2025-04-20_18-46-12.jpg">

:arrow_up: [К содержанию](#содержание)

---
---
### Дальнейшее развитие

Дальнейшее развитие сервиса по кластеризации и классификации клиентов на основе RFM, ABC и XYZ анализа будет сосредоточено на следующих направлениях:

1. Оптимизация и валидация аналитических подходов: Поскольку выявленные гипотезы не подтвердились, приоритет будет отдан доработке методов кластеризации и классификации. Важно повторно анализировать данные, включая дополнительные переменные, такие как поведенческие признаки клиентов, и использовать более совершенные алгоритмы (например, гибридные модели, основанные на ансамблевом обучении).

2. Повышение качества данных: Работа над чистотой и полнотой данных имеет первостепенное значение. Будут разработаны более строгие критерии для обработки и очистки данных, а также механизмы для постоянного мониторинга их качества. Возможно использование методов активного обучения для улучшения разметки данных.

3. Разработка рекомендательной системы: На основе когортного анализа будет осуществлена разработка рекомендательной системы, которая будет предлагать клиентам товары, основываясь на их предыдущем поведении и предпочтениях. Это позволит повысить конверсию и уменьшить вероятность оттока клиентов.

4. Глубокая интеграция с маркетингом: Планируется интеграция аналитической информации в маркетинговую стратегию, что позволит осуществлять более персонализированные предложения. Ввод новых инструментариев, таких как push-уведомления и Email-маркетинг, будет использовать данные сегментации для таргетированного воздействия.

5. Автоматизация и расширение архитектуры сервиса: Стремление к построению более модульной и масштабируемой архитектуры с использованием облачных технологий (например, AWS или Google Cloud) для обработки больших объемов данных в реальном времени. Разработка API для интеграции с другими системами.

6. Проведение A/B тестирования: Внедрение системы для A/B тестирования различных маркетинговых подходов и акций. Это позволит объективно оценивать эффективность различных стратегий на основе фактических данных о поведении клиентов.

7. Анализ конкурентной среды: Регулярный мониторинг и анализ действий конкурентов в области маркетинга и клиентского сервиса, что может дать новые идеи для улучшения своих подходов.


---
---
### Контрибьюторы
- Анна Назаренко - [unearthlypresence01](https://github.com/unearthlypresence01)
- Иоанн Лебедев - [OIJTUMUCT](https://github.com/OIJTUMUCT)
- Кузнецов Кирилл - [hotdonkey](https://github.com/hotdonkey)
- Кондрашов Александр - [MRP4TIK](https://github.com/alexkondrashov7)


:arrow_up: [К содержанию](#содержание)